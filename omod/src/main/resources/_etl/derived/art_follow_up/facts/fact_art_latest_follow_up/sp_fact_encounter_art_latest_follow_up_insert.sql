-- $BEGIN
INSERT INTO mamba_fact_art_latest_follow_up (client_id,
                                      encounter_id,
                                      encounter_datetime,
                                      weight_in_kg,
                                      cd4_count,
                                      current_who_hiv_stage,
                                      nutritional_status,
                                      tb_screening_result,
                                      enrollment_date,
                                      hiv_confirmed_date,
                                      art_start_date,
                                      days_difference,
                                      followup_date,
                                      regimen,
                                      arv_dose_days,
                                      pregnancy_status,
                                      breast_feeding_status,
                                      follow_up_status,
                                      ti,
                                      treatment_end_date,
                                      next_visit_date,
                                      hiv_viral_load_count,
                                      hiv_viral_load_status,
                                      viral_load_test_status,
                                      on_antiretroviral_therapy,
                                      viral_load_test_indication,
                                      antiretroviral_side_effects,
                                      anitiretroviral_adherence_level,
                                      date_of_reported_hiv_viral_load,
                                      date_viral_load_results_received,
                                      routine_viral_load_test_indication,
                                      targeted_viral_load_test_indication,
                                      dsd_category,
                                      tpt_start_date,
                                      tpt_completed_date,
                                      tpt_discontinued_date,
                                      tuberculosis_treatment_end_date)
WITH RankedFollowups AS (
    SELECT
        client_id,
        encounter_id,
        encounter_datetime,
        weight_in_kg,
        cd4_count,
        current_who_hiv_stage,
        nutritional_status,
        tb_screening_result,
        enrollment_date,
        hiv_confirmed_date,
        art_start_date,
        days_difference,
        followup_date,
        regimen,
        arv_dose_days,
        pregnancy_status,
        breast_feeding_status,
        follow_up_status,
        ti,
        treatment_end_date,
        next_visit_date,
        hiv_viral_load_count,
        hiv_viral_load_status,
        viral_load_test_status,
        on_antiretroviral_therapy,
        viral_load_test_indication,
        antiretroviral_side_effects,
        anitiretroviral_adherence_level,
        date_of_reported_hiv_viral_load,
        date_viral_load_results_received,
        routine_viral_load_test_indication,
        targeted_viral_load_test_indication,
        dsd_category,
        tpt_start_date,
        tpt_completed_date,
        tpt_discontinued_date,
        tuberculosis_treatment_end_date,
        ROW_NUMBER() OVER (PARTITION BY client_id ORDER BY followup_date DESC) AS rn
    FROM mamba_fact_art_follow_up
)
SELECT
    client_id,
    encounter_id,
    encounter_datetime,
    weight_in_kg,
    cd4_count,
    current_who_hiv_stage,
    nutritional_status,
    tb_screening_result,
    enrollment_date,
    hiv_confirmed_date,
    art_start_date,
    days_difference,
    followup_date,
    regimen,
    arv_dose_days,
    pregnancy_status,
    breast_feeding_status,
    follow_up_status,
    ti,
    treatment_end_date,
    next_visit_date,
    hiv_viral_load_count,
    hiv_viral_load_status,
    viral_load_test_status,
    on_antiretroviral_therapy,
    viral_load_test_indication,
    antiretroviral_side_effects,
    anitiretroviral_adherence_level,
    date_of_reported_hiv_viral_load,
    date_viral_load_results_received,
    routine_viral_load_test_indication,
    targeted_viral_load_test_indication,
    dsd_category,
    tpt_start_date,
    tpt_completed_date,
    tpt_discontinued_date,
    tuberculosis_treatment_end_date
FROM RankedFollowups
WHERE rn = 1;
-- $END
